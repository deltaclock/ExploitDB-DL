import urllib
import os
W = '\033[0m'  # white (normal)
R = '\033[31m'  # red
G = '\033[32m'  # green
OR = '\033[33m'  # orange
B = '\033[34m'  # blue
P = '\033[35m'  # purple
try:
    from bs4 import BeautifulSoup
except ImportError:
    print R + "[*] Download and Install BeautifulSoup first"


# TODO: remove ''........clear scr ....detect os..


def getLinks(lastPage, languageNum, fileName):
    text = open(fileName, "a")
    i = 1
    print '\n[*] Please wait while fetching all the URLs...'
    for i in range(1, lastPage + 1):
        url = 'https://www.exploit-db.com/papers/?l=%d&pg=%d' % (
            languageNum, i)
        try:
            html = urllib.urlopen(url).read()
            soup = BeautifulSoup(html, "lxml")
            for links, titles in zip(soup.find_all('td', class_="dlink"), soup.find_all('td', class_="description")):
                for link, title in zip(links.find_all('a'), titles.find_all('a')):
                    text.write(title.get('title').encode('utf-8') +
                               '\n' + link.get('href') + '\n')
                    i += 1
        except IOError as e:
            print "[*] You fucked up\nUnable to find url"
            print e
    text.close()
    return '\n[*] Successfully saved %i URLs' % i


def dlFiles(fileWithUrls, pathToSaveFiles):
    try:
        print R + 'This might take a while..'
        with open(fileWithUrls, 'r') as fl:
            for line1 in fl:
                line2 = next(fl).strip('\n')
                print B + 'Getting ' + W + line1.strip('\n') + line2[-4:]
                data = urllib.urlopen(line2)
                with open(pathToSaveFiles + (line1.strip('\n') + line2[-4:]).replace('/', '-'), 'wb') as f:
                    f.write(data.read())
    except IOError:
        return '[*] Could not the file with the URLs!'
    return '[*] All files Downloaded!'


def langMenu():
    print 30 * "-", "MENU", 30 * "-"
    print "[1] English"
    print "[2] French"
    print "[3] Arabic"
    print "[4] Spanish"
    print "[5] Persian"
    print "[6] Italian"
    print "[7] Turkish"
    print "[8] German"
    print "[9] Portuguese"
    print "[10] Hebrew"
    print "[0] All"
    print 67 * "-"

    lang = []

    while True:
        try:
            choice = int(raw_input('[+] Enter a language number '))
        except ValueError:
            print "\nInvalid choice! Enter one number.."
            raw_input("Press any key to try again..")
        if 1 <= choice < 11:
            print "\nYou selected language ", choice
            lang.append(choice)
            more = raw_input("\nDo you wanna select another language? (y/n) ")
            if more[0] == 'y':
                print "\nEnter another language number "
            else:
                print "\nYour selected language/s are: ", lang[0::]
                break
        elif choice == 0:
            lang = range(1, 11)
            print "\nYou've choosen to save ALL languages URLs..This might take \
            awhile :)"
            break
        else:
            print "\nYou must select one of the previous numbers! "
            raw_input("Press any key to try again..")
    return lang


if __name__ == '__main__':
    print G + "\n[*] This script will save all Papers from exploitDB\n" + W

    filename = raw_input("[+] Enter the name of the new file.. ") + ".txt"
    if os.path.isfile(filename):
        os.remove(filename)
    for language in langMenu():
        pEnd = int(raw_input(
            '[+] What is the last page number, \
            You wanna download for language %i? ' % language))
        print getLinks(pEnd, language, filename)

    prompt = raw_input("[*] Do you wanna also\
                       download the files? (y / n) ").lower()

    if prompt[0] == 'y':
        directory = 'exploitDB-papers/'
        if not os.path.exists(directory):
            os.makedirs(directory)
        print dlFiles(filename, directory)
    else:
        print "You will regret it..."
